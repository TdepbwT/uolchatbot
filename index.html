<!DOCTYPE html>
<html>

<head>
    <style>
		body {
            /* Set the background image for the entire webpage */
            background-image: url('imgs/uolbg.png'); /* Add your background image URL here */
            background-size: cover; /* Cover the entire viewport */
            background-position: center; /* Center the background image */
            margin: 0; /* Remove default margin */
            padding: 0; /* Remove default padding */
            font-family: Verdana, sans-serif; /* Specify default font */
        }
	
        #chat-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            cursor: pointer;
            width: 100px;
            /* Adjust as needed */
            height: 100px;
            /* Adjust as needed */
        }

        #chat-window {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 500px;
            border: 3px solid black;
            padding: 10px;
            display: none;
            /* Start with the chat window hidden */
            overflow: hidden;
            /* Hide scrollbar */
            background-color: white;
            border-radius: 10px;
        }

        #chat-close {
            position: absolute;
            top: 0;
            right: 0;
            cursor: pointer;
            width: 15px;
            height: 15px;
            padding: 10px;
        }

        #chat-messages {
            width: 100%;
            overflow-y: auto;
            /* Scrollbar only on the right */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding-right: 10px; /* Add padding to create space for scrollbar */
        }

        #chat-input {
            width: 100%;
            font-size: 16px;
            height: 25px;
            border: 3px solid black;
            padding: 5px;
            margin: 5px 0;
            font-family: Verdana, sans-serif;
        }

        #chat-title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid black;
        }

        #chat-input-container {
            /* This only exists so the bar at the bottom actually centers itself */
            display: flex;
            justify-content: center;
        }

        #chat-title {
            text-align: center;
            font-weight: bold;
            font-family: Verdana, sans-serif;
            flex-grow: 1;
        }

        .user-message-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* Align user messages to the right */
            width: 100%;
        }

        .user-message {
            background-color: #047e8b;
            /* Change the background color */
            border-radius: 12px;
            /* Round the corners */
            padding: 8px;
            /* Add some padding */
            margin: 3px 0;
            /* Add some margin */
            width: fit-content;
            /* Make the width fit the content */
            max-width: 80%;
            /* Limit the maximum width */
            border: 1px solid #ccc;
            font-family: Verdana, sans-serif;
			color: white;
        }

        .robot-message-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align bot messages to the left */
            width: 100%;
        }

        .robot-message {
            background-color: #002147;
            /* Light green with slight alpha */
            border-radius: 12px;
            /* Round the corners */
            padding: 8px;
            /* Add some padding */
            margin: 3px 0;
            /* Add some margin */
            width: fit-content;
            /* Make the width fit the content */
            max-width: 80%;
            /* Limit the maximum width */
            border: 1px solid #ccc;
            font-family: Verdana, sans-serif;
			color: white;
        }

        .message-name {
            font-family: Verdana, sans-serif;
            /* Change the font */
            font-weight: normal;
            /* Make it not bold */
            font-size: 0.8em;
            /* Make it smaller */
            font-style: italic;
            margin: 5px 0;
        }
    </style>
</head>


<body>
    <img id="chat-icon" src="imgs/chaticon.png" alt="Chat Icon" onclick="openChat()"> <!-- Opens the chat -->
    <div id="chat-window"> <!-- Div for the entire chat window that can be opened later -->
        <div id="chat-title-bar"><!-- Title and close button -->
            <div id="chat-title">University of Lincoln Chatbot</div>
            <img id="chat-close" src="imgs/close.png" alt="Close Chat" onclick="closeChat()">
        </div>
        <div id="chat-messages"></div> <!-- Div for the messages inside of the window -->
        <div id="chat-input-container"><!-- Text box at the bottom of the window -->
            <input type="text" id="chat-input" onkeydown="checkForEnter(event)"> <!-- Checks for enter when the chat input is selected -->
        </div>
    </div>

    </div>

    <script>

        //Global variables for messy logic handling
        let isChatWindowInitialised = false;
        let sentCourseSelectionMessage = false;
        let waitingForCourseSelectionConfirmation = false;
        let possibleCourse = "";

        //Opens the chat window and runs the initialise function to check whether to ask about courses or not 
        function openChat() {
            document.getElementById('chat-icon').style.display = 'none';
            var chatWindow = document.getElementById('chat-window');
            chatWindow.style.display = 'flex';
            chatWindow.style.flexDirection = 'column';
            chatWindow.style.justifyContent = 'space-between';
            initialise();
        }

        //Hides the chat window
        function closeChat() {
            var chatWindow = document.getElementById('chat-window');
            chatWindow.style.display = '';
            chatWindow.style.flexDirection = '';
            chatWindow.style.justifyContent = '';
            chatWindow.style.display = 'none';
            document.getElementById('chat-icon').style.display = 'block';
        }

        //If the user sends a message this runs
        function checkForEnter(event) {
            messageToBeSent = event.target.value.trim()
            // Check if the Enter key was pressed and if the input field is not empty
            if (event.key === 'Enter' && messageToBeSent !== '') {
                // Prevent the default action to stop the form from being submitted
                event.preventDefault();
                // Send the message
                sendMessage(messageToBeSent, false);
                //Check whether or not the bot is asking the user about their course
                if(sentCourseSelectionMessage == true)
                {
                    sendContextToPython(messageToBeSent)
                    .then(responseData =>{ //Waits for a response from the API call 
                        console.log(responseData)
                        possibleCourse = responseData.trim() //Returns course name as responseData
                        sendMessage(("Are you talking about " + possibleCourse + "? (Please type yes or no)"), true)
                    })
                

                    sentCourseSelectionMessage = false; //Control flow variables (must be a better way of doing this)
                    waitingForCourseSelectionConfirmation = true;
                }
                else if (waitingForCourseSelectionConfirmation == true)
                {
                    if(messageToBeSent.toUpperCase() == "YES")
                    {
                        sendMessage("Great! What do you want to know?", true)
                        waitingForCourseSelectionConfirmation = false;
                    }
                    else if(messageToBeSent.toUpperCase() == "NO")
                    {
                        sendMessage("Please re enter the course you're interested in. Be specific with the phrasing", true)
                        sentCourseSelectionMessage = true;
                    }
                    else
                    {
                        sendMessage("Please re enter yes or no", true)
                    }

                }
                else 
                {
                    //The main loop that runs when a user has already selected a course
                    sendMessageToPython(messageToBeSent) 
                    .then(responseData =>{ //Waits for a response from the API call 
                        sendMessage(responseData, true) //Returns API data
                    })
                }


                // Clear the input field
                event.target.value = '';
            }
        }

        function sendMessage(messageText, isRobot) {
            // Get the chat messages div
            var messages = document.getElementById('chat-messages');

            // Create a new div for the message container
            var messageContainer = document.createElement('div');
            messageContainer.className = isRobot ? 'robot-message-container' : 'user-message-container';

            // Create a new div for the name
            var name = document.createElement('div');
            name.textContent = isRobot ? 'UoL Chatbot:' : 'User:';
            name.className = 'message-name';

            // Create a new div for the message
            var message = document.createElement('div');
            message.textContent = messageText;
            message.className = isRobot ? 'robot-message' : 'user-message';

            // Add the name and message to the message container
            messageContainer.appendChild(name);
            messageContainer.appendChild(message);

            // Add the message container to the chat messages
            messages.appendChild(messageContainer);

            // Scroll to the bottom of the chat messages
            messages.scrollTop = messages.scrollHeight;
        }
    
        function sendMessageToPython(message){ // API call taking in a message (from user input) and querying the pythonside API for a response 
            return new Promise((resolve, reject) => { //Returns a promise for safety - without it the script can run past it accidentally
                fetch("http://localhost:8000/message", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json", //Return it as a JSON format so its standardised
                    },
                    body: JSON.stringify({message: message})
                })
                .then(response => {
                    return response.json();
                })
                .then(responseData => {
                    resolve(responseData[0]); //The actual final data that is returned resolves the promise
                })
                .catch(error => {
                    reject(error); //Or throws an error if it doesnt work
                })

            })
        }

        function sendContextToPython(message){
            return new Promise((resolve, reject) => {
                fetch("http://localhost:8000/context", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({message: message})
                })
                .then(response => {
                    return response.json();
                })
                .then(responseData => {
                    resolve(responseData[0]);
                })
                .catch(error => {
                    reject(error);
                })

            })
        }

        function initialise(){ //Initialise loop that can be expanded. Only runs the first time the chat window is opened. 
            if (!isChatWindowInitialised){
                sendMessage("Hey, I'm the University of Lincoln Course selection chatbot. What course are you interested?", true)
                isChatWindowInitialised = true;
                sentCourseSelectionMessage = true;
            }
        }

    </script>
</body>

</html>